<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baya - Pulse</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'slide-up': 'slideUp 0.3s ease-out' },
                    keyframes: { slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: white; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); background-attachment: fixed; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .white-card { background: #ffffff; color: #0f172a; border-radius: 0.75rem; padding: 1.25rem; border: 1px solid #cbd5e1; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .white-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #94a3b8; }
        .badge { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; padding: 4px 8px; border-radius: 99px; letter-spacing: 0.05em; }
        .badge-active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-closed { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .mini-bar { height: 6px; border-radius: 3px; background: #f1f5f9; margin-top: 4px; overflow: hidden; }
        .mini-fill { height: 100%; background: #3b82f6; }
        .focus-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 50; overflow-y: auto; padding: 2rem; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
        .loader { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid black; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .auth-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 8px; outline: none; margin-top: 4px; }
        .auth-input:focus { border-color: #3b82f6; }
        .ai-card { border-left: 4px solid; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 2rem; display: flex; gap: 1rem; align-items: start; }
        .ai-danger { background: rgba(254, 242, 242, 0.95); border-color: #ef4444; color: #991b1b; }
        .ai-success { background: rgba(240, 253, 244, 0.95); border-color: #22c55e; color: #166534; }
        .ai-warning { background: rgba(255, 251, 235, 0.95); border-color: #f59e0b; color: #92400e; }
        .ai-neutral { background: rgba(248, 250, 252, 0.95); border-color: #94a3b8; color: #475569; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">
    <div id="app" class="flex-grow flex items-center justify-center p-4"></div>
    <div class="text-center p-4 text-xs text-gray-500 glass border-t border-t-white/5 fixed bottom-0 w-full z-0">Baya Secure v4.3</div>

    <script>
        // 1. VERSION RESET
        try { if (localStorage.getItem('baya_version') !== '4.3') { localStorage.clear(); localStorage.setItem('baya_version', '4.3'); } } catch(e) {}

        // 2. CONFIG
        const BASE_URL = 'http://localhost:3000';
        const API_URL = `${BASE_URL}/api`;

        // 3. SOCKET
        const socket = io(BASE_URL);
        socket.on('connect', () => { if(state.existingRoomCode) socket.emit('join_room', state.existingRoomCode); });
        socket.on('poll_updated', (updatedPoll) => {
            const newList = state.pollsList.map(p => (p.pollId === updatedPoll.pollId || p._id === updatedPoll._id) ? updatedPoll : p);
            const exists = newList.find(p => p.pollId === updatedPoll.pollId || p._id === updatedPoll._id);
            if (!exists) newList.push(updatedPoll);
            
            let newFocused = state.focusedPoll;
            if (state.focusedPoll && (state.focusedPoll.pollId === updatedPoll.pollId || state.focusedPoll._id === updatedPoll._id)) newFocused = updatedPoll;
            
            let newPoll = state.poll;
            if (state.poll && (state.poll.pollId === updatedPoll.pollId || state.poll._id === updatedPoll._id)) newPoll = updatedPoll;

            updateState({ pollsList: newList, focusedPoll: newFocused, poll: newPoll });
        });

        // 4. STATE
        let state = JSON.parse(localStorage.getItem('baya_state')) || { 
            view: 'home', poll: null, pollsList: [], existingRoomCode: null, userId: `guest_${Date.now()}`, focusedPoll: null, isCreating: false,
            user: null, token: null
        };
        let pollRefreshInterval = null;

        // 5. HELPERS
        function updateState(updates) { state = { ...state, ...updates }; localStorage.setItem('baya_state', JSON.stringify(state)); render(); }
        function showToast(msg, type='success') { if(typeof Toastify==='function') Toastify({text: msg, duration: 3000, gravity: "top", position: "center", style: { background: type==='success'?"#10B981":"#EF4444"}}).showToast(); else alert(msg); }
        
        async function apiCall(ep, m='GET', b=null) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
            const opts = { method: m, headers }; if (b) opts.body = JSON.stringify(b);
            const r = await fetch(`${API_URL}${ep}`, opts); const d = await r.json(); if (!r.ok) throw new Error(d.message || 'Request failed'); return d;
        }

        function logout() {
            updateState({ view: 'home', token: null, user: null, pollsList: [], existingRoomCode: null });
            showToast("Logged out");
        }

        // 6. AI ENGINE
        function generateInsight(poll, total) {
            if (total < 2) return { title: "Gathering Data...", text: "Wait for at least 2 votes.", style: "bg-gray-800 border-gray-700 text-gray-400" };
            let max = -1, winIdx = -1; poll.votes.forEach((v,i) => { if(v > max) { max = v; winIdx = i; } });
            const winOption = (poll.options[winIdx] || "").toLowerCase(); const percent = Math.round((max/total) * 100);
            const neg = ['no','bad','slow','lost','confused']; const pos = ['yes','good','fast','understand'];
            if (neg.some(w => winOption.includes(w)) && percent > 50) return { title: "üö® Alert: Confusion", text: `<b>${percent}%</b> are struggling. Pause and re-explain.`, style: "bg-red-900/30 border-red-500 text-red-200" };
            if (pos.some(w => winOption.includes(w)) && percent > 65) return { title: "‚úÖ Green Light", text: `<b>${percent}%</b> comprehension. Speed up.`, style: "bg-green-900/30 border-green-500 text-green-200" };
            return { title: "‚ÑπÔ∏è Trend", text: `Leading: <b>"${poll.options[winIdx]}"</b> (${percent}%).`, style: "bg-gray-800 border-gray-600 text-gray-300" };
        }

        // 7. VIEWS
        const Views = {
            home: () => `
                <div class="max-w-4xl w-full text-center animate-slide-up z-10 pb-16">
                    <h1 class="text-7xl font-extrabold tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">baya.</h1>
                    <p class="text-xl text-gray-400 mb-12 font-light">Real-time classroom intelligence.</p>
                    <div class="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                        <button onclick="${state.token ? "updateState({view: 'lecturer-dashboard'})" : "updateState({view: 'login'})"}" class="glass p-8 rounded-2xl hover:bg-white/10 transition-all text-left group"><div class="text-6xl mb-4 group-hover:scale-110 transition">üìä</div><h2 class="text-2xl font-bold">Host Session</h2><p class="text-sm text-gray-400">Login to manage polls</p></button>
                        <button onclick="updateState({view: 'student-join'})" class="glass p-8 rounded-2xl hover:bg-white/10 transition-all text-left group"><div class="text-6xl mb-4 group-hover:scale-110 transition">üëã</div><h2 class="text-2xl font-bold">Join Session</h2><p class="text-sm text-gray-400">Enter code to vote</p></button>
                    </div>
                </div>`,

            'login': () => `
                <div class="w-full max-w-sm animate-slide-up z-10 pb-12">
                    <button onclick="updateState({view: 'home'})" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div class="glass p-8 rounded-3xl">
                        <h2 class="text-2xl font-bold mb-6 text-center">Host Login</h2>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-4"><label class="text-xs font-bold text-gray-400 uppercase">Email</label><input id="email" type="email" required class="auth-input" placeholder="host@baya.com"></div>
                            <div class="mb-6"><label class="text-xs font-bold text-gray-400 uppercase">Password</label><input id="password" type="password" required class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                            <button id="btn-login" type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition flex justify-center items-center gap-2">Login <span id="spinner-login" class="hidden loader"></span></button>
                        </form>
                        <p class="text-center text-sm text-gray-400 mt-6">New here? <button onclick="updateState({view: 'register'})" class="text-blue-400 font-bold hover:underline">Create Account</button></p>
                    </div>
                </div>`,

            'register': () => `
                <div class="w-full max-w-sm animate-slide-up z-10 pb-12">
                    <button onclick="updateState({view: 'home'})" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div class="glass p-8 rounded-3xl">
                        <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                        <form onsubmit="handleRegister(event)">
                            <div class="mb-4"><label class="text-xs font-bold text-gray-400 uppercase">Full Name</label><input id="reg-name" type="text" required class="auth-input" placeholder="John Doe"></div>
                            <div class="mb-4"><label class="text-xs font-bold text-gray-400 uppercase">Email</label><input id="reg-email" type="email" required class="auth-input" placeholder="host@baya.com"></div>
                            <div class="mb-6"><label class="text-xs font-bold text-gray-400 uppercase">Password</label><input id="reg-password" type="password" required class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                            <button id="btn-reg" type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold transition flex justify-center items-center gap-2">Sign Up <span id="spinner-reg" class="hidden loader"></span></button>
                        </form>
                        <p class="text-center text-sm text-gray-400 mt-6">Have an account? <button onclick="updateState({view: 'login'})" class="text-blue-400 font-bold hover:underline">Login</button></p>
                    </div>
                </div>`,

            'lecturer-dashboard': () => {
                // *** SAFE REDIRECT ***
                if (!state.token || !state.user) {
                    setTimeout(() => updateState({view: 'login'}), 0);
                    return `<div class="flex h-screen items-center justify-center"><div class="loader"></div></div>`;
                }

                // *** NAME EXTRACTION LOGIC (The Fix) ***
                let displayName = "Host";
                if (state.user && state.user.name) {
                    // Extract first name and capitalize it
                    displayName = state.user.name.split(' ')[0];
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                }

                const hasPolls = state.pollsList.length > 0;
                const sortedPolls = [...state.pollsList].sort((a,b) => (a.status === 'active' ? -1 : 1));
                
                return `
                ${state.focusedPoll ? renderFocusedModal() : ''}
                <div class="w-full max-w-5xl animate-slide-up z-10 pb-12">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-3xl font-bold">Hello, ${displayName}</h2>
                            <p class="text-gray-400 text-sm mt-1">Room Code: <span class="font-mono text-blue-400 text-lg font-bold cursor-pointer" onclick="copyCode('${state.existingRoomCode || '...' }')">${state.existingRoomCode || 'Start Session'}</span></p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="logout()" class="text-sm text-gray-400 hover:text-red-400 px-3 font-bold">Log Out</button>
                            <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg hover:shadow-blue-500/20 transition transform hover:-translate-y-1"><i class="fa-solid fa-plus"></i> New Poll</button>
                        </div>
                    </div>
                    ${!hasPolls ? `<div class="glass p-12 rounded-3xl text-center border-dashed border-2 border-white/10"><div class="text-4xl mb-4">üì≠</div><h3 class="text-xl font-bold text-gray-300">Start Session</h3><p class="text-gray-500 mb-6">Create your first question.</p><button onclick="openCreateModal()" class="text-blue-400 hover:text-blue-300 font-bold">Create Now ‚Üí</button></div>` 
                    : `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${sortedPolls.map((p) => { const isActive = p.status === 'active'; const total = p.votes ? p.votes.reduce((a,b)=>a+b,0) : 0; const title = p.question || p.title || "Untitled Question"; return `<div onclick="focusPoll('${p.pollId || p._id}')" class="white-card relative group cursor-pointer"><div class="flex justify-between items-start mb-3"><span class="badge ${isActive ? 'badge-active' : 'badge-closed'}"><i class="fa-solid fa-circle text-[6px] mr-1 align-middle"></i> ${isActive ? 'ACTIVE' : 'CLOSED'}</span><span class="text-xs text-gray-400 font-mono">${total} votes</span></div><h3 class="font-bold text-lg text-slate-800 leading-tight mb-4 line-clamp-2">${title}</h3><div class="space-y-2">${p.options.slice(0,2).map((opt, i) => { const v = p.votes[i] || 0; const pct = total ? Math.round((v/total)*100) : 0; return `<div><div class="flex justify-between text-xs text-slate-500 mb-1"><span>${opt}</span><span>${pct}%</span></div><div class="mini-bar"><div class="mini-fill" style="width: ${pct}%"></div></div></div>`; }).join('')}${p.options.length > 2 ? `<div class="text-xs text-slate-400 mt-1">+ ${p.options.length - 2} more</div>` : ''}</div></div>`; }).join('')}</div>`}
                </div>
                <div id="create-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white text-gray-900 w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-slide-up">
                        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">New Question</h3><button onclick="closeCreateModal()" class="text-gray-400 hover:text-black"><i class="fa-solid fa-xmark fa-lg"></i></button></div>
                        <form onsubmit="handleCreate(event)"><div class="mb-4"><label class="text-xs font-bold text-gray-500 uppercase">Question</label><input id="question" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-blue-500 mt-1" placeholder="e.g. Do you understand?"></div><div class="mb-4"><label class="text-xs font-bold text-gray-500 uppercase">Options</label><div id="options-list" class="space-y-2 mt-1"><input class="opt-input w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none" placeholder="Option 1" required><input class="opt-input w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none" placeholder="Option 2" required></div><button type="button" onclick="addOptionInput()" class="mt-2 text-xs font-bold text-blue-600 uppercase">+ Add Option</button></div><button id="btn-create" type="submit" class="w-full bg-black text-white py-3 rounded-xl font-bold hover:bg-gray-800 transition flex justify-center items-center gap-2">Launch <span id="spinner-create" class="hidden loader"></span></button></form>
                    </div>
                </div>`;
            },

            'student-join': () => `<div class="w-full max-w-sm animate-slide-up z-10 pb-12"><button onclick="updateState({view: 'home'})" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Back</button><div class="glass p-8 rounded-3xl text-center"><h2 class="text-2xl font-bold mb-2">Join Session</h2><p class="text-sm text-gray-400 mb-8">Enter the code provided by the host.</p><form onsubmit="handleJoin(event)"><input id="room-code-input" required maxlength="6" class="w-full bg-black/30 border border-white/10 rounded-2xl p-6 text-center text-3xl font-mono font-bold uppercase text-white outline-none mb-6 tracking-widest placeholder-gray-700" placeholder="X9Y2"><button id="btn-join" type="submit" class="bg-white text-black w-full py-4 rounded-xl font-bold text-lg hover:bg-gray-200 transition flex justify-center items-center gap-2">Enter Session <span id="spinner-join" class="hidden loader"></span></button></form></div></div>`,
            'student-poll-list': () => `<div class="w-full max-w-md animate-slide-up z-10 pb-12"><div class="glass p-8 rounded-3xl"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Available Polls</h2><button onclick="updateState({view: 'student-join', pollsList: []})" class="text-xs text-gray-500 hover:text-white">Exit Room</button></div><div class="space-y-4">${state.pollsList.map((p, i) => { const isActive = p.status !== 'closed'; const total = p.votes ? p.votes.reduce((a,b)=>a+b,0) : 0; const title = p.question || p.title || "Untitled Question"; return `<button onclick="${isActive ? `selectPoll(${i})` : ''}" class="w-full text-left white-card group ${!isActive ? 'opacity-60 cursor-not-allowed' : ''}"><div class="flex justify-between items-start mb-2"><div class="font-bold text-lg text-slate-900 group-hover:text-blue-600 transition line-clamp-2">${title}</div><span class="badge ${isActive ? 'badge-active' : 'badge-closed'}">${isActive ? 'LIVE' : 'CLOSED'}</span></div><div class="text-xs text-slate-500 font-medium"><i class="fa-solid fa-check-to-slot mr-1"></i> ${total} votes cast</div></button>`; }).join('')}</div></div></div>`,
            'student-vote': () => { if (!state.poll) return ''; const title = state.poll.question || state.poll.title || "Untitled"; const isActive = state.poll.status !== 'closed'; return `<div class="w-full max-w-md animate-slide-up z-10 pb-12"><div class="glass p-8 rounded-3xl"><div class="flex justify-between items-center mb-6"><span class="text-xs font-bold text-blue-400 uppercase tracking-widest">Live Poll</span><button onclick="updateState({view: ${state.pollsList.length > 1 ? "'student-poll-list'" : "'student-join'"}, poll: null})" class="text-xs text-gray-500">Back</button></div><h2 class="text-2xl font-bold mb-8 leading-snug">${title}</h2>${!isActive ? `<div class="p-4 bg-red-500/20 border border-red-500 text-red-200 rounded-xl mb-6 text-center font-bold">‚õî Voting is closed</div>` : ''}<div class="space-y-3">${state.poll.options.map((opt, i) => `<button ${!isActive ? 'disabled' : ''} onclick="handleVote('${opt}')" class="w-full p-5 white-card text-left text-lg font-bold hover:border-blue-500 ${!isActive ? 'opacity-50 cursor-not-allowed' : ''}">${opt}</button>`).join('')}</div></div></div>`; },
            'student-results': () => { const total = state.poll.votes.reduce((a,b)=>a+b,0); return `<div class="w-full max-w-md animate-slide-up z-10 pb-12 text-center"><div class="glass p-8 rounded-3xl"><div class="w-16 h-16 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl"><i class="fa-solid fa-check"></i></div><h2 class="text-2xl font-bold mb-2">Vote Submitted!</h2><p class="text-sm text-gray-400 mb-8">Waiting for host...</p><button onclick="updateState({view: ${state.pollsList.length > 1 ? "'student-poll-list'" : "'student-join'"}, poll: null})" class="mt-8 text-sm text-gray-500 hover:text-white">Vote in another poll</button></div></div>`; }
        };

        function renderFocusedModal() { if (!state.focusedPoll) return ''; const p = state.focusedPoll; const total = p.votes.reduce((a,b)=>a+b,0); const isActive = p.status === 'active'; const title = p.question || p.title || "Untitled"; const insight = generateInsight(p, total); return `<div class="focus-overlay flex items-center justify-center animate-slide-up"><div class="w-full max-w-3xl glass p-8 rounded-3xl shadow-2xl relative"><button onclick="updateState({focusedPoll: null})" class="absolute top-6 right-6 text-gray-400 hover:text-white bg-white/10 w-10 h-10 rounded-full flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button><div class="flex items-center gap-4 mb-6"><span class="badge ${isActive ? 'badge-active' : 'badge-closed'} text-sm px-3 py-1">${isActive ? 'LIVE' : 'CLOSED'}</span></div><h2 class="text-3xl font-bold mb-6 leading-tight">${title}</h2><div class="ai-card ${insight.style} border-l-4 p-5 rounded-lg mb-8 flex gap-4"><div class="text-2xl pt-1"><i class="fa-solid ${insight.icon}"></i></div><div><div class="text-xs font-bold uppercase tracking-widest opacity-80 mb-1">${insight.title}</div><div class="text-sm leading-relaxed opacity-90">${insight.text}</div></div></div><div class="space-y-3 mb-8">${p.options.map((opt, i) => { const pct = total ? Math.round((p.votes[i]/total)*100) : 0; return `<div class="relative h-16 bg-white/5 rounded-xl overflow-hidden flex items-center px-6 border border-white/10"><div class="absolute top-0 left-0 h-full bg-blue-500 opacity-20 transition-all duration-700" style="width: ${pct}%"></div><div class="relative z-10 w-full flex justify-between items-center"><span class="text-lg font-medium">${opt}</span><div class="text-right"><span class="font-bold text-xl mr-2">${pct}%</span> <span class="text-xs text-gray-400">(${p.votes[i]})</span></div></div></div>`; }).join('')}</div><div class="flex justify-between items-center pt-6 border-t border-white/10"><div class="text-gray-400">${total} total votes</div><button onclick="toggleStatus('${p.pollId || p._id}', '${isActive ? 'closed' : 'active'}')" class="px-6 py-3 rounded-xl font-bold transition text-white ${isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-green-600 hover:bg-green-700'}">${isActive ? 'Close Voting' : 'Re-open Voting'}</button></div></div></div>`; }

        // 8. RENDER LOOP
        function render() { const app = document.getElementById('app'); if (Views[state.view]) app.innerHTML = Views[state.view](); }

        // 9. LOGIC
        async function handleLogin(e) {
            e.preventDefault(); const btn = document.getElementById('btn-login'); const spin = document.getElementById('spinner-login'); btn.disabled = true; spin.classList.remove('hidden');
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            try {
                const data = await apiCall('/users/login', 'POST', { email, password });
                console.log("USER DATA RECEIVED:", data); // DEBUG LINE
                updateState({ view: 'lecturer-dashboard', token: data.token, user: data, pollsList: [], existingRoomCode: null });
                showToast("Welcome back!");
            } catch(e) { showToast(e.message); } finally { btn.disabled = false; spin.classList.add('hidden'); }
        }

        async function handleRegister(e) { e.preventDefault(); const btn = document.getElementById('btn-reg'); const spin = document.getElementById('spinner-reg'); btn.disabled = true; spin.classList.remove('hidden'); const name = document.getElementById('reg-name').value; const email = document.getElementById('reg-email').value; const password = document.getElementById('reg-password').value; try { const data = await apiCall('/users/register', 'POST', { name, email, password }); updateState({ view: 'lecturer-dashboard', token: data.token, user: data, pollsList: [], existingRoomCode: null }); showToast("Account created!"); } catch(e) { showToast(e.message); } finally { btn.disabled = false; spin.classList.add('hidden'); } }
        async function handleCreate(e) { e.preventDefault(); const btn = document.getElementById('btn-create'); const spin = document.getElementById('spinner-create'); btn.disabled = true; spin.classList.remove('hidden'); const q = document.getElementById('question').value; const opts = Array.from(document.querySelectorAll('.opt-input')).map(i=>i.value).filter(v=>v); const pl = { question: q, options: opts }; if (state.existingRoomCode) pl.roomCode = state.existingRoomCode; try { const createdPoll = await apiCall('/polls', 'POST', pl); const activeCode = state.existingRoomCode || createdPoll.roomCode; const res = await apiCall(`/polls/room/${activeCode}`); const polls = res.data ? res.data : (Array.isArray(res) ? res : [res]); state.isCreating = false; socket.emit('join_room', activeCode); updateState({ view: 'lecturer-dashboard', pollsList: polls, existingRoomCode: activeCode }); closeCreateModal(); showToast("Poll Created!"); } catch(e) { showToast(e.message); } finally { btn.disabled = false; spin.classList.add('hidden'); } }
        async function handleJoin(e) { e.preventDefault(); const code = document.getElementById('room-code-input').value.trim().toUpperCase(); try { const res = await apiCall(`/polls/room/${code}`); let polls = res.data ? res.data : (Array.isArray(res) ? res : [res]); if(!polls.length) throw new Error("Room not found"); socket.emit('join_room', code); if (polls.length > 1) updateState({ view: 'student-poll-list', pollsList: polls }); else updateState({ view: 'student-vote', poll: polls[0], pollsList: polls }); } catch (err) { showToast("Invalid Code"); } }
        function focusPoll(id) { const p = state.pollsList.find(x => (x.pollId === id || x._id === id)); updateState({ focusedPoll: p }); }
        function openCreateModal() { state.isCreating = true; document.getElementById('create-modal').classList.remove('hidden'); }
        function closeCreateModal() { state.isCreating = false; document.getElementById('create-modal').classList.add('hidden'); }
        function addOptionInput() { const d = document.createElement('input'); d.className = 'opt-input w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none mt-2'; d.placeholder = 'Next Option'; d.required = true; document.getElementById('options-list').appendChild(d); }
        async function toggleStatus(id, status) { try { await apiCall(`/polls/${id}/status`, 'PATCH', { status }); } catch(e) {} }
        function selectPoll(i) { updateState({ view: 'student-vote', poll: state.pollsList[i] }); }
        async function handleVote(opt) { try { const id = state.poll.pollId || state.poll._id; await apiCall(`/polls/${id}/vote`, 'POST', { option: opt }); updateState({ view: 'student-results', poll: state.poll }); showToast("Vote Sent!"); } catch (e) { showToast("Error voting"); } }
        function startAutoRefresh() { pollRefreshInterval = setInterval(async () => { if (state.isCreating) return; try { if (state.view === 'lecturer-dashboard' && state.existingRoomCode) { const res = await apiCall(`/polls/room/${state.existingRoomCode}`); const polls = res.data || res; let focused = state.focusedPoll ? polls.find(p => (p._id === state.focusedPoll._id || p.pollId === state.focusedPoll.pollId)) : null; updateState({ pollsList: polls, focusedPoll: focused }); } else if (state.view.includes('student') && state.pollsList.length > 0) { const code = state.pollsList[0].roomCode; const res = await apiCall(`/polls/room/${code}`); updateState({ pollsList: res.data || res }); } } catch(e) {} }, 5000); }
        function copyCode(c) { navigator.clipboard.writeText(c); showToast("Copied!"); }

        render();
    </script>
</body>
</html>  -->





 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baya - Pulse</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'slide-up': 'slideUp 0.3s ease-out', 'pulse-red': 'pulseRed 2s infinite' },
                    keyframes: { 
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseRed: { '0%, 100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' }, '70%': { boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: white; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); background-attachment: fixed; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .white-card { background: #ffffff; color: #0f172a; border-radius: 0.75rem; padding: 1.25rem; border: 1px solid #cbd5e1; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .white-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #94a3b8; }
        .badge { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; padding: 4px 8px; border-radius: 99px; letter-spacing: 0.05em; }
        .badge-active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-closed { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .mini-bar { height: 6px; border-radius: 3px; background: #f1f5f9; margin-top: 4px; overflow: hidden; }
        .mini-fill { height: 100%; background: #3b82f6; transition: width 0.5s ease-out; }
        .focus-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 50; overflow-y: auto; padding: 2rem; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
        .loader { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid black; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .auth-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 8px; outline: none; margin-top: 4px; }
        .auth-input:focus { border-color: #3b82f6; }
        
        /* AI Styles */
        .ai-card { border-left: 4px solid; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 2rem; display: flex; gap: 1rem; align-items: start; }
        .ai-danger { background: rgba(254, 242, 242, 0.95); border-color: #ef4444; color: #991b1b; }
        .ai-success { background: rgba(240, 253, 244, 0.95); border-color: #22c55e; color: #166534; }
        .ai-warning { background: rgba(255, 251, 235, 0.95); border-color: #f59e0b; color: #92400e; }
        .ai-neutral { background: rgba(248, 250, 252, 0.95); border-color: #94a3b8; color: #475569; }
        
        /* THERMOMETER STYLE */
        .thermometer { width: 12px; height: 150px; background: #334155; border-radius: 99px; position: relative; overflow: hidden; border: 1px solid #475569; }
        .mercury { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #22c55e, #eab308, #ef4444); transition: height 0.5s ease-out; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">
    <div id="app" class="flex-grow flex items-center justify-center p-4"></div>
    <div class="text-center p-4 text-xs text-gray-500 glass border-t border-t-white/5 fixed bottom-0 w-full z-0">Baya Secure v4.3 (Fixed)</div>

    <script>
        // 1. CONFIG
        const BASE_URL = 'http://localhost:3000';
        const API_URL = `${BASE_URL}/api`;

        // 2. STATE
        let state = JSON.parse(localStorage.getItem('baya_state')) || { 
            view: 'home', poll: null, pollsList: [], existingRoomCode: null, userId: `guest_${Date.now()}`, focusedPoll: null, isCreating: false,
            user: null, token: null, confusionLevel: 0, whispers: []
        };
        let pollRefreshInterval = null;
        let decayInterval = null;

        // 3. SOCKET
        const socket = io(BASE_URL);
        
        socket.on('connect', () => { 
            console.log("Connected");
            if(state.existingRoomCode) socket.emit('join_room', state.existingRoomCode); 
        });
        
        socket.on('poll_updated', (updatedPoll) => {
            const newList = (state.pollsList||[]).map(p => (p.pollId === updatedPoll.pollId || p._id === updatedPoll._id) ? updatedPoll : p);
            const exists = newList.find(p => p.pollId === updatedPoll.pollId || p._id === updatedPoll._id);
            if (!exists) newList.push(updatedPoll);
            
            let newFocused = state.focusedPoll;
            if (state.focusedPoll && (state.focusedPoll.pollId === updatedPoll.pollId || state.focusedPoll._id === updatedPoll._id)) newFocused = updatedPoll;
            
            let newPoll = state.poll;
            if (state.poll && (state.poll.pollId === updatedPoll.pollId || state.poll._id === updatedPoll._id)) newPoll = updatedPoll;

            updateState({ pollsList: newList, focusedPoll: newFocused, poll: newPoll });
        });

        // *** FIX: ADD MISSING LISTENERS FOR PANIC & WHISPER ***
        socket.on('panic_alert', (data) => {
            let newLevel = Math.min((state.confusionLevel || 0) + 10, 100);
            updateState({ confusionLevel: newLevel });
            if(state.view === 'lecturer-dashboard') showToast("Student sent Panic Signal!", "error");
        });

        socket.on('whisper_message', (data) => {
            const newWhispers = [data.message, ...(state.whispers || [])].slice(0, 5); 
            updateState({ whispers: newWhispers });
            if(state.view === 'lecturer-dashboard') showToast("New Whisper received", "info");
        });

        // 4. HELPERS
        function updateState(updates) { state = { ...state, ...updates }; localStorage.setItem('baya_state', JSON.stringify(state)); render(); }
        function showToast(msg, type='success') { if(typeof Toastify==='function') Toastify({text: msg, duration: 3000, gravity: "top", position: "center", style: { background: type==='success'?"#10B981":"#EF4444"}}).showToast(); else alert(msg); }
        async function apiCall(ep, m='GET', b=null) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
            const opts = { method: m, headers }; if (b) opts.body = JSON.stringify(b);
            const r = await fetch(`${API_URL}${ep}`, opts); const d = await r.json(); if (!r.ok) throw new Error(d.message || 'Request failed'); return d;
        }
        function logout() { updateState({ view: 'home', token: null, user: null, pollsList: [], existingRoomCode: null }); showToast("Logged out"); }

        // 5. LOGIC: PANIC & WHISPER
        function getActiveCode() {
            // Find correct room code based on view
            if(state.existingRoomCode) return state.existingRoomCode;
            if(state.poll) return state.poll.roomCode;
            if(state.pollsList && state.pollsList.length > 0) return state.pollsList[0].roomCode;
            return null;
        }

        function sendPanic() {
            const code = getActiveCode();
            if(!code) return showToast("Join a room first!", "error");
            socket.emit('panic_button', code);
            showToast("Signal sent!", "error");
        }

        function sendWhisper() {
            const input = document.getElementById('whisper-input');
            const msg = input.value.trim();
            const code = getActiveCode();
            if(!msg || !code) return;
            
            socket.emit('whisper', { roomCode: code, message: msg });
            input.value = '';
            showToast("Sent anonymously", "success");
        }

        // DECAY LOGIC
        if (!decayInterval) {
            decayInterval = setInterval(() => {
                if (state.confusionLevel > 0) updateState({ confusionLevel: Math.max(state.confusionLevel - 5, 0) });
            }, 2000);
        }

        // 6. AI ENGINE
        function generateInsight(poll, total) {
            if (total < 2) return { title: "Gathering Data...", text: "Wait for at least 2 votes.", style: "bg-gray-800 border-gray-700 text-gray-400" };
            let max = -1, winIdx = -1; poll.votes.forEach((v,i) => { if(v > max) { max = v; winIdx = i; } });
            const winOption = (poll.options[winIdx] || "").toLowerCase(); const percent = Math.round((max/total) * 100);
            const neg = ['no','bad','slow','lost','confused']; const pos = ['yes','good','fast','understand'];
            if (neg.some(w => winOption.includes(w)) && percent > 50) return { title: "üö® Alert: Confusion", text: `<b>${percent}%</b> are struggling. Pause and re-explain.`, style: "bg-red-900/30 border-red-500 text-red-200" };
            if (pos.some(w => winOption.includes(w)) && percent > 65) return { title: "‚úÖ Green Light", text: `<b>${percent}%</b> comprehension. Speed up.`, style: "bg-green-900/30 border-green-500 text-green-200" };
            return { title: "‚ÑπÔ∏è Trend", text: `Leading: <b>"${poll.options[winIdx]}"</b> (${percent}%).`, style: "bg-gray-800 border-gray-600 text-gray-300" };
        }

        // 7. VIEWS
        const Views = {
            home: () => `
                <div class="max-w-4xl w-full text-center animate-slide-up z-10 pb-16">
                    <h1 class="text-7xl font-extrabold tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">baya.</h1>
                    <p class="text-xl text-gray-400 mb-12 font-light">Real-time classroom intelligence.</p>
                    <div class="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                        <button onclick="${state.token ? "updateState({view: 'lecturer-dashboard'})" : "updateState({view: 'login'})"}" class="glass p-8 rounded-2xl hover:bg-white/10 transition-all text-left group"><div class="text-6xl mb-4 group-hover:scale-110 transition">üìä</div><h2 class="text-2xl font-bold">Host Session</h2><p class="text-sm text-gray-400">Login to manage polls</p></button>
                        <button onclick="updateState({view: 'student-join'})" class="glass p-8 rounded-2xl hover:bg-white/10 transition-all text-left group"><div class="text-6xl mb-4 group-hover:scale-110 transition">üëã</div><h2 class="text-2xl font-bold">Join Session</h2><p class="text-sm text-gray-400">Enter code to vote</p></button>
                    </div>
                </div>`,

            'login': () => `
                <div class="w-full max-w-sm animate-slide-up z-10 pb-12">
                    <button onclick="updateState({view: 'home'})" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div class="glass p-8 rounded-3xl">
                        <h2 class="text-2xl font-bold mb-6 text-center">Host Login</h2>
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-4"><label class="text-xs font-bold text-gray-400 uppercase">Email</label><input id="email" type="email" required class="auth-input" placeholder="host@baya.com"></div>
                            <div class="mb-6"><label class="text-xs font-bold text-gray-400 uppercase">Password</label><input id="password" type="password" required class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                            <button id="btn-login" type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition flex justify-center items-center gap-2">Login <span id="spinner-login" class="hidden loader"></span></button>
                        </form>
                        <p class="text-center text-sm text-gray-400 mt-6">New here? <button onclick="updateState({view: 'register'})" class="text-blue-400 font-bold hover:underline">Create Account</button></p>
                    </div>
                </div>`,

            'register': () => `
                <div class="w-full max-w-sm animate-slide-up z-10 pb-12">
                    <button onclick="updateState({view: 'home'})" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div class="glass p-8 rounded-3xl">
                        <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                        <form onsubmit="handleRegister(event)">
                            <div class="mb-4"><label class="text-xs font-bold text-gray-400 uppercase">Full Name</label><input id="reg-name" type="text" required class="auth-input" placeholder="John Doe"></div>
                            <div class="mb-4"><label class="text-xs font-bold text-gray-400 uppercase">Email</label><input id="reg-email" type="email" required class="auth-input" placeholder="host@baya.com"></div>
                            <div class="mb-6"><label class="text-xs font-bold text-gray-400 uppercase">Password</label><input id="reg-password" type="password" required class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                            <button id="btn-reg" type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold transition flex justify-center items-center gap-2">Sign Up <span id="spinner-reg" class="hidden loader"></span></button>
                        </form>
                        <p class="text-center text-sm text-gray-400 mt-6">Have an account? <button onclick="updateState({view: 'login'})" class="text-blue-400 font-bold hover:underline">Login</button></p>
                    </div>
                </div>`,

            'lecturer-dashboard': () => {
                // *** SAFE REDIRECT ***
                if (!state.token || !state.user) {
                    setTimeout(() => updateState({view: 'login'}), 0);
                    return `<div class="flex h-screen items-center justify-center"><div class="loader"></div></div>`;
                }

                // *** NAME EXTRACTION LOGIC (The Fix) ***
                let displayName = "Host";
                if (state.user && state.user.name) {
                    displayName = state.user.name.split(' ')[0];
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                }

                const hasPolls = (state.pollsList||[]).length > 0;
                const sortedPolls = [...(state.pollsList||[])].sort((a,b) => (a.status === 'active' ? -1 : 1));
                
                return `
                ${state.focusedPoll ? renderFocusedModal() : ''}
                
                <div class="fixed right-6 top-32 glass p-3 rounded-full flex flex-col items-center gap-2 z-40 hidden md:flex animate-slide-up">
                    <span class="text-[10px] font-bold text-gray-400 uppercase vertical-text tracking-widest" style="writing-mode: vertical-rl;">Confusion</span>
                    <div class="thermometer"><div class="mercury" style="height: ${state.confusionLevel}%"></div></div>
                    <div class="text-xs font-mono text-white font-bold">${state.confusionLevel}%</div>
                </div>

                <div class="w-full max-w-5xl animate-slide-up z-10 pb-12">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-3xl font-bold">Hello, ${displayName}</h2>
                            <p class="text-gray-400 text-sm mt-1">Room Code: <span class="font-mono text-blue-400 text-lg font-bold cursor-pointer" onclick="copyCode('${state.existingRoomCode || '...' }')">${state.existingRoomCode || 'Start Session'}</span></p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="logout()" class="text-sm text-gray-400 hover:text-red-400 px-3 font-bold">Log Out</button>
                            <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg hover:shadow-blue-500/20 transition transform hover:-translate-y-1"><i class="fa-solid fa-plus"></i> New Poll</button>
                        </div>
                    </div>

                    <div class="glass p-6 rounded-2xl border border-blue-500/30 relative overflow-hidden mb-8 min-h-[100px]">
                        <div class="absolute top-4 left-4 text-xs font-bold text-blue-400 uppercase tracking-widest"><i class="fa-solid fa-wind mr-1"></i> Live Whispers</div>
                        <div class="mt-6 flex flex-wrap gap-3 items-center">
                            ${(state.whispers || []).length === 0 ? '<span class="text-gray-600 text-sm italic">No whispers yet...</span>' : ''}
                            ${(state.whispers || []).map(w => `<span class="animate-pulse bg-blue-500/10 border border-blue-500/30 text-blue-200 px-3 py-1 rounded-full text-sm animate-slide-up">${w}</span>`).join('')}
                        </div>
                    </div>

                    ${!hasPolls ? `<div class="glass p-12 rounded-3xl text-center border-dashed border-2 border-white/10"><div class="text-4xl mb-4">üì≠</div><h3 class="text-xl font-bold text-gray-300">Start Session</h3><p class="text-gray-500 mb-6">Create your first question.</p><button onclick="openCreateModal()" class="text-blue-400 hover:text-blue-300 font-bold">Create Now ‚Üí</button></div>` 
                    : `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${sortedPolls.map((p) => { const isActive = p.status === 'active'; const total = p.votes ? p.votes.reduce((a,b)=>a+b,0) : 0; const title = p.question || p.title || "Untitled Question"; return `<div onclick="focusPoll('${p.pollId || p._id}')" class="white-card relative group cursor-pointer"><div class="flex justify-between items-start mb-3"><span class="badge ${isActive ? 'badge-active' : 'badge-closed'}"><i class="fa-solid fa-circle text-[6px] mr-1 align-middle"></i> ${isActive ? 'ACTIVE' : 'CLOSED'}</span><span class="text-xs text-gray-400 font-mono">${total} votes</span></div><h3 class="font-bold text-lg text-slate-800 leading-tight mb-4 line-clamp-2">${title}</h3><div class="space-y-2">${p.options.slice(0,2).map((opt, i) => { const v = p.votes[i] || 0; const pct = total ? Math.round((v/total)*100) : 0; return `<div><div class="flex justify-between text-xs text-slate-500 mb-1"><span>${opt}</span><span>${pct}%</span></div><div class="mini-bar"><div class="mini-fill" style="width: ${pct}%"></div></div></div>`; }).join('')}${p.options.length > 2 ? `<div class="text-xs text-slate-400 mt-1">+ ${p.options.length - 2} more</div>` : ''}</div></div>`; }).join('')}</div>`}
                </div>
                ${renderCreateModal()}`;
            },

            'student-join': () => `<div class="w-full max-w-sm animate-slide-up z-10 pb-12"><button onclick="updateState({view: 'home'})" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Back</button><div class="glass p-8 rounded-3xl text-center"><h2 class="text-2xl font-bold mb-2">Join Session</h2><p class="text-sm text-gray-400 mb-8">Enter the code provided by the host.</p><form onsubmit="handleJoin(event)"><input id="room-code-input" required maxlength="6" class="w-full bg-black/30 border border-white/10 rounded-2xl p-6 text-center text-3xl font-mono font-bold uppercase text-white outline-none mb-6 tracking-widest placeholder-gray-700" placeholder="X9Y2"><button id="btn-join" type="submit" class="bg-white text-black w-full py-4 rounded-xl font-bold text-lg hover:bg-gray-200 transition flex justify-center items-center gap-2">Enter Session <span id="spinner-join" class="hidden loader"></span></button></form></div></div>`,
            'student-poll-list': () => renderStudentTools() + `<div class="w-full max-w-md animate-slide-up z-10 pb-12"><div class="glass p-8 rounded-3xl"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Available Polls</h2><button onclick="updateState({view: 'student-join', pollsList: []})" class="text-xs text-gray-500 hover:text-white">Exit Room</button></div><div class="space-y-4">${(state.pollsList||[]).map((p, i) => { const isActive = p.status !== 'closed'; const total = p.votes ? p.votes.reduce((a,b)=>a+b,0) : 0; const title = p.question || p.title || "Untitled Question"; return `<button onclick="${isActive ? `selectPoll(${i})` : ''}" class="w-full text-left white-card group ${!isActive ? 'opacity-60 cursor-not-allowed' : ''}"><div class="flex justify-between items-start mb-2"><div class="font-bold text-lg text-slate-900 group-hover:text-blue-600 transition line-clamp-2">${title}</div><span class="badge ${isActive ? 'badge-active' : 'badge-closed'}">${isActive ? 'LIVE' : 'CLOSED'}</span></div><div class="text-xs text-slate-500 font-medium"><i class="fa-solid fa-check-to-slot mr-1"></i> ${total} votes cast</div></button>`; }).join('')}</div></div></div>`,
            'student-vote': () => { if (!state.poll) return ''; const title = state.poll.question || state.poll.title || "Untitled"; const isActive = state.poll.status !== 'closed'; return renderStudentTools() + `<div class="w-full max-w-md animate-slide-up z-10 pb-12"><div class="glass p-8 rounded-3xl"><div class="flex justify-between items-center mb-6"><span class="text-xs font-bold text-blue-400 uppercase tracking-widest">Live Poll</span><button onclick="updateState({view: ${state.pollsList.length > 1 ? "'student-poll-list'" : "'student-join'"}, poll: null})" class="text-xs text-gray-500">Back</button></div><h2 class="text-2xl font-bold mb-8 leading-snug">${title}</h2>${!isActive ? `<div class="p-4 bg-red-500/20 border border-red-500 text-red-200 rounded-xl mb-6 text-center font-bold">‚õî Voting is closed</div>` : ''}<div class="space-y-3">${state.poll.options.map((opt, i) => `<button ${!isActive ? 'disabled' : ''} onclick="handleVote('${opt}')" class="w-full p-5 white-card text-left text-lg font-bold hover:border-blue-500 ${!isActive ? 'opacity-50 cursor-not-allowed' : ''}">${opt}</button>`).join('')}</div></div></div>`; },
            'student-results': () => renderStudentTools() + `<div class="w-full max-w-md animate-slide-up z-10 pb-12 text-center"><div class="glass p-8 rounded-3xl"><div class="w-16 h-16 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl"><i class="fa-solid fa-check"></i></div><h2 class="text-2xl font-bold mb-2">Vote Submitted!</h2><p class="text-sm text-gray-400 mb-8">Waiting for host...</p><button onclick="updateState({view: ${state.pollsList.length > 1 ? "'student-poll-list'" : "'student-join'"}, poll: null})" class="mt-8 text-sm text-gray-500 hover:text-white">Vote in another poll</button></div></div>`
        };

        // SHARED COMPONENTS & MODALS
        function renderStudentTools() {
            return `
            <button onclick="sendPanic()" class="fixed bottom-6 right-6 w-16 h-16 bg-red-500/10 border-2 border-red-500/50 rounded-full flex items-center justify-center text-3xl shadow-lg backdrop-blur-md active:scale-90 active:bg-red-500 active:text-white transition-all duration-200 z-50 group"><span class="group-hover:animate-pulse">ü§Ø</span></button>
            <div class="fixed bottom-6 left-6 right-24 glass rounded-full p-2 flex items-center border border-white/10 z-40"><input id="whisper-input" type="text" placeholder="Whisper..." class="bg-transparent text-sm text-white px-4 w-full outline-none placeholder-gray-500"><button onclick="sendWhisper()" class="bg-white/10 hover:bg-white/20 w-8 h-8 rounded-full flex items-center justify-center text-xs transition text-white"><i class="fa-solid fa-paper-plane"></i></button></div>`;
        }

        function renderCreateModal() {
            return `<div id="create-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white text-gray-900 w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-slide-up">
                    <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold">New Question</h3><button onclick="closeCreateModal()" class="text-gray-400 hover:text-black"><i class="fa-solid fa-xmark fa-lg"></i></button></div>
                    <form onsubmit="handleCreate(event)"><div class="mb-4"><label class="text-xs font-bold text-gray-500 uppercase">Question</label><input id="question" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-blue-500 mt-1" placeholder="e.g. Do you understand?"></div><div class="mb-4"><label class="text-xs font-bold text-gray-500 uppercase">Options</label><div id="options-list" class="space-y-2 mt-1"><input class="opt-input w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none" placeholder="Option 1" required><input class="opt-input w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none" placeholder="Option 2" required></div><button type="button" onclick="addOptionInput()" class="mt-2 text-xs font-bold text-blue-600 uppercase">+ Add Option</button></div><button id="btn-create" type="submit" class="w-full bg-black text-white py-3 rounded-xl font-bold hover:bg-gray-800 transition flex justify-center items-center gap-2">Launch <span id="spinner-create" class="hidden loader"></span></button></form>
                </div>
            </div>`;
        }

        function renderFocusedModal() { if (!state.focusedPoll) return ''; const p = state.focusedPoll; const total = p.votes.reduce((a,b)=>a+b,0); const isActive = p.status === 'active'; const title = p.question || p.title || "Untitled"; const insight = generateInsight(p, total); return `<div class="focus-overlay flex items-center justify-center animate-slide-up"><div class="w-full max-w-3xl glass p-8 rounded-3xl shadow-2xl relative"><button onclick="updateState({focusedPoll: null})" class="absolute top-6 right-6 text-gray-400 hover:text-white bg-white/10 w-10 h-10 rounded-full flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button><div class="flex items-center gap-4 mb-6"><span class="badge ${isActive ? 'badge-active' : 'badge-closed'} text-sm px-3 py-1">${isActive ? 'LIVE' : 'CLOSED'}</span></div><h2 class="text-3xl font-bold mb-6 leading-tight">${title}</h2><div class="ai-card ${insight.style} border-l-4 p-5 rounded-lg mb-8 flex gap-4"><div class="text-2xl pt-1"><i class="fa-solid ${insight.icon}"></i></div><div><div class="text-xs font-bold uppercase tracking-widest opacity-80 mb-1">${insight.title}</div><div class="text-sm leading-relaxed opacity-90">${insight.text}</div></div></div><div class="space-y-3 mb-8">${p.options.map((opt, i) => { const pct = total ? Math.round((p.votes[i]/total)*100) : 0; return `<div class="relative h-16 bg-white/5 rounded-xl overflow-hidden flex items-center px-6 border border-white/10"><div class="absolute top-0 left-0 h-full bg-blue-500 opacity-20 transition-all duration-700" style="width: ${pct}%"></div><div class="relative z-10 w-full flex justify-between items-center"><span class="text-lg font-medium">${opt}</span><div class="text-right"><span class="font-bold text-xl mr-2">${pct}%</span> <span class="text-xs text-gray-400">(${p.votes[i]})</span></div></div></div>`; }).join('')}</div><div class="flex justify-between items-center pt-6 border-t border-white/10"><div class="text-gray-400">${total} total votes</div><button onclick="toggleStatus('${p.pollId || p._id}', '${isActive ? 'closed' : 'active'}')" class="px-6 py-3 rounded-xl font-bold transition text-white ${isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-green-600 hover:bg-green-700'}">${isActive ? 'Close Voting' : 'Re-open Voting'}</button></div></div></div>`; }

        // 8. RENDER LOOP
        function render() { const app = document.getElementById('app'); if (Views[state.view]) app.innerHTML = Views[state.view](); }

        // 9. LOGIC
        async function handleLogin(e) {
            e.preventDefault(); const btn = document.getElementById('btn-login'); const spin = document.getElementById('spinner-login'); btn.disabled = true; spin.classList.remove('hidden');
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            try {
                const data = await apiCall('/users/login', 'POST', { email, password });
                console.log("USER DATA RECEIVED:", data); // DEBUG LINE
                updateState({ view: 'lecturer-dashboard', token: data.token, user: data, pollsList: [], existingRoomCode: null });
                showToast("Welcome back!");
            } catch(e) { showToast(e.message); } finally { btn.disabled = false; spin.classList.add('hidden'); }
        }

        async function handleRegister(e) { e.preventDefault(); const btn = document.getElementById('btn-reg'); const spin = document.getElementById('spinner-reg'); btn.disabled = true; spin.classList.remove('hidden'); const name = document.getElementById('reg-name').value; const email = document.getElementById('reg-email').value; const password = document.getElementById('reg-password').value; try { const data = await apiCall('/users/register', 'POST', { name, email, password }); updateState({ view: 'lecturer-dashboard', token: data.token, user: data, pollsList: [], existingRoomCode: null }); showToast("Account created!"); } catch(e) { showToast(e.message); } finally { btn.disabled = false; spin.classList.add('hidden'); } }
        async function handleCreate(e) { e.preventDefault(); const btn = document.getElementById('btn-create'); const spin = document.getElementById('spinner-create'); btn.disabled = true; spin.classList.remove('hidden'); const q = document.getElementById('question').value; const opts = Array.from(document.querySelectorAll('.opt-input')).map(i=>i.value).filter(v=>v); const pl = { question: q, options: opts }; if (state.existingRoomCode) pl.roomCode = state.existingRoomCode; try { const createdPoll = await apiCall('/polls', 'POST', pl); const activeCode = state.existingRoomCode || createdPoll.roomCode; const res = await apiCall(`/polls/room/${activeCode}`); const polls = res.data ? res.data : (Array.isArray(res) ? res : [res]); state.isCreating = false; socket.emit('join_room', activeCode); updateState({ view: 'lecturer-dashboard', pollsList: polls, existingRoomCode: activeCode }); closeCreateModal(); showToast("Poll Created!"); } catch(e) { showToast(e.message); } finally { btn.disabled = false; spin.classList.add('hidden'); } }
        async function handleJoin(e) { e.preventDefault(); const code = document.getElementById('room-code-input').value.trim().toUpperCase(); try { const res = await apiCall(`/polls/room/${code}`); let polls = res.data ? res.data : (Array.isArray(res) ? res : [res]); if(!polls.length) throw new Error("Room not found"); socket.emit('join_room', code); if (polls.length > 1) updateState({ view: 'student-poll-list', pollsList: polls }); else updateState({ view: 'student-vote', poll: polls[0], pollsList: polls }); } catch (err) { showToast("Invalid Code"); } }
        function focusPoll(id) { const p = state.pollsList.find(x => (x.pollId === id || x._id === id)); updateState({ focusedPoll: p }); }
        function openCreateModal() { state.isCreating = true; document.getElementById('create-modal').classList.remove('hidden'); }
        function closeCreateModal() { state.isCreating = false; document.getElementById('create-modal').classList.add('hidden'); }
        function addOptionInput() { const d = document.createElement('input'); d.className = 'opt-input w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none mt-2'; d.placeholder = 'Next Option'; d.required = true; document.getElementById('options-list').appendChild(d); }
        async function toggleStatus(id, status) { try { await apiCall(`/polls/${id}/status`, 'PATCH', { status }); } catch(e) {} }
        function selectPoll(i) { updateState({ view: 'student-vote', poll: state.pollsList[i] }); }
        async function handleVote(opt) { try { const id = state.poll.pollId || state.poll._id; await apiCall(`/polls/${id}/vote`, 'POST', { option: opt }); updateState({ view: 'student-results', poll: state.poll }); showToast("Vote Sent!"); } catch (e) { showToast("Error voting"); } }
        function startAutoRefresh() { pollRefreshInterval = setInterval(async () => { if (state.isCreating) return; try { if (state.view === 'lecturer-dashboard' && state.existingRoomCode) { const res = await apiCall(`/polls/room/${state.existingRoomCode}`); const polls = res.data || res; let focused = state.focusedPoll ? polls.find(p => (p._id === state.focusedPoll._id || p.pollId === state.focusedPoll.pollId)) : null; updateState({ pollsList: polls, focusedPoll: focused }); } else if (state.view.includes('student') && state.pollsList.length > 0) { const code = state.pollsList[0].roomCode; const res = await apiCall(`/polls/room/${code}`); updateState({ pollsList: res.data || res }); } } catch(e) {} }, 5000); }
        function copyCode(c) { navigator.clipboard.writeText(c); showToast("Copied!"); }

        render();
    </script>
</body>
</html> 



